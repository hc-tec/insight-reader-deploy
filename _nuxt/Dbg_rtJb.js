import{ac as k,A as w,$ as S,l as b,m as $,r as g,a5 as B}from"#entry";const E="$s";function p(...o){const a=typeof o[o.length-1]=="string"?o.pop():void 0;typeof o[0]!="string"&&o.unshift(a);const[s,n]=o;if(!s||typeof s!="string")throw new TypeError("[nuxt] [useState] key must be a string: "+s);if(n!==void 0&&typeof n!="function")throw new Error("[nuxt] [useState] init must be a function: "+n);const c=E+s,i=k(),r=w(i.payload.state,c);if(r.value===void 0&&n){const u=n();if(S(u))return i.payload.state[c]=u,u;r.value=u}return r}const l="insightreader_token",h="insightreader_user",_=()=>{const o=B(),a=p("auth-token",()=>null),s=p("auth-user",()=>null),n=b(()=>!!a.value&&!!s.value),c=()=>{try{const e=localStorage.getItem(l),t=localStorage.getItem(h);e&&t&&(a.value=e,s.value=JSON.parse(t))}catch(e){console.error("加载认证状态失败:",e),r()}},i=e=>{a.value=e.access_token,s.value=e.user,localStorage.setItem(l,e.access_token),localStorage.setItem(h,JSON.stringify(e.user))},r=()=>{a.value=null,s.value=null,localStorage.removeItem(l),localStorage.removeItem(h)},u=()=>{window.location.href=`${o.public.apiBase}/api/v1/auth/google/login`},f=()=>{window.location.href=`${o.public.apiBase}/api/v1/auth/github/login`},d=async e=>{try{console.log("[useAuth] 请求魔法链接:",e),console.log("[useAuth] API Base:",o.public.apiBase);const t=await $fetch(`${o.public.apiBase}/api/v1/auth/magic-link/request`,{method:"POST",body:{email:e}});return console.log("[useAuth] 魔法链接请求成功:",t),{success:!0,message:t.message}}catch(t){return console.error("[useAuth] 魔法链接请求失败:",t),{success:!1,error:t?.data?.detail||t?.message||"发送魔法链接失败"}}},v=async e=>{try{console.log("[useAuth] 验证魔法链接, token:",e.substring(0,20)+"..."),console.log("[useAuth] 验证 URL:",`${o.public.apiBase}/api/v1/auth/magic-link/verify`);const t=await $fetch(`${o.public.apiBase}/api/v1/auth/magic-link/verify?token=${e}`);return console.log("[useAuth] 验证成功，用户信息:",t.user),i(t),{success:!0,user:t.user}}catch(t){return console.error("[useAuth] 验证失败:",t),{success:!1,error:t?.data?.detail||t?.message||"验证魔法链接失败或已过期"}}},y=e=>{i(e)},m=()=>{r(),window.location.href="/"},A=()=>{if(!a.value)throw new Error("未登录");return{Authorization:`Bearer ${a.value}`,"Content-Type":"application/json"}};return $(()=>{c()}),{token:g(a),user:g(s),isAuthenticated:n,loginWithGoogle:u,loginWithGithub:f,requestMagicLink:d,verifyMagicLink:v,handleOAuthCallback:y,logout:m,getAuthHeaders:A}};export{_ as a,p as u};
