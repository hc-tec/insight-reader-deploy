import{ad as E,A,$ as b,l as $,m as T,r as g,a5 as _}from"#entry";const j="$s";function d(...o){const n=typeof o[o.length-1]=="string"?o.pop():void 0;typeof o[0]!="string"&&o.unshift(n);const[s,a]=o;if(!s||typeof s!="string")throw new TypeError("[nuxt] [useState] key must be a string: "+s);if(a!==void 0&&typeof a!="function")throw new Error("[nuxt] [useState] init must be a function: "+a);const u=j+s,c=E(),r=A(c.payload.state,u);if(r.value===void 0&&a){const i=a();if(b(i))return c.payload.state[u]=i,i;r.value=i}return r}const f="insightreader_token",h="insightreader_user",I=()=>{const o=_(),n=d("auth-token",()=>null),s=d("auth-user",()=>null),a=$(()=>!!n.value&&!!s.value),u=()=>{try{const t=localStorage.getItem(f),e=localStorage.getItem(h);t&&e&&(n.value=t,s.value=JSON.parse(e))}catch(t){console.error("加载认证状态失败:",t),r()}},c=t=>{n.value=t.access_token,s.value=t.user,localStorage.setItem(f,t.access_token),localStorage.setItem(h,JSON.stringify(t.user))},r=()=>{n.value=null,s.value=null,localStorage.removeItem(f),localStorage.removeItem(h)},i=()=>{window.location.href=`${o.public.apiBase}/api/v1/auth/google/login`},y=()=>{window.location.href=`${o.public.apiBase}/api/v1/auth/github/login`},v=async t=>{try{const e=await fetch(`${o.public.apiBase}/api/v1/auth/magic-link/request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});if(!e.ok){const p=await e.json();throw new Error(p.detail||"发送魔法链接失败")}return{success:!0,message:(await e.json()).message}}catch(e){return{success:!1,error:e instanceof Error?e.message:"发送魔法链接失败"}}},m=async t=>{try{const e=await fetch(`${o.public.apiBase}/api/v1/auth/magic-link/verify?token=${t}`,{method:"GET"});if(!e.ok){const p=await e.json();throw new Error(p.detail||"验证魔法链接失败")}const l=await e.json();return c(l),{success:!0,user:l.user}}catch(e){return{success:!1,error:e instanceof Error?e.message:"验证魔法链接失败"}}},w=t=>{c(t)},k=()=>{r(),window.location.href="/"},S=()=>{if(!n.value)throw new Error("未登录");return{Authorization:`Bearer ${n.value}`,"Content-Type":"application/json"}};return T(()=>{u()}),{token:g(n),user:g(s),isAuthenticated:a,loginWithGoogle:i,loginWithGithub:y,requestMagicLink:v,verifyMagicLink:m,handleOAuthCallback:w,logout:k,getAuthHeaders:S}};export{I as a,d as u};
